<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="MyMusic">

<resultMap type="MyMusic" id="MyMusicResultMap">
	<result column="l_no" property="l_no"/>
	<result column="m_id" property="m_id"/>
	<result column="l_name" property="l_name"/>
	<result column="l_private_yn" property="l_private_yn"/>
	<result column="l_image" property="l_image"/>
	<collection column="m_id" property="sounds" select="selectSound"></collection>
</resultMap>

<resultMap type="Sound" id="mySoundResultMap">
	<result column="s_no" property="s_no"/>
	<result column="a_no" property="a_no"/>
	<result column="s_name" property="s_name"/>
	<result column="s_lyrics1" property="s_lyrics1"/>
	<result column="s_lyrics2" property="s_lyrics2"/>
	<result column="s_age_yn" property="s_age_yn"/>
	<result column="s_path" property="s_path"/>
	<result column="g_no" property="g_no"/>
	<result column="cnt_like" property="cnt_like"/>
	<result column="a_cover" property="a_cover"/>
	<result column="a_name" property="a_name"/>
	<result column="g_name" property="g_name"/>
	<collection column="{m_id=m_id, l_no=l_no}" property="singers" select="mySoundSingerList"></collection>
	<collection column="{m_id=m_id, l_no=l_no}" property="sound_writers" select="mySoundWriterList"></collection>
	<collection column="{m_id=m_id, l_no=l_no}" property="sound_composers" select="mySoundComposerList"></collection>
</resultMap>

<resultMap type="Sound" id="soundResultMap">
	<result column="s_no" property="s_no"/>
	<result column="a_no" property="a_no"/>
	<result column="s_name" property="s_name"/>
	<result column="s_lyrics1" property="s_lyrics1"/>
	<result column="s_lyrics2" property="s_lyrics2"/>
	<result column="s_age_yn" property="s_age_yn"/>
	<result column="s_path" property="s_path"/>
	<result column="g_no" property="g_no"/>
	<result column="cnt_like" property="cnt_like"/>
	<result column="a_cover" property="a_cover"/>
	<result column="a_name" property="a_name"/>
	<result column="g_name" property="g_name"/>
	<collection column="{a_no=a_no, s_no=s_no}" property="singers" select="soundSingerList"></collection>
</resultMap>

<!-- 내 플레이 리스트 목록 -->
<select id="selectPlaylist" resultType="MyMusic">
	select * from playlist where m_id = #{m_id}
</select>

<!-- 플레이 리스트에 노래 담기 -->
<insert id="insertSound" parameterType="map">
	insert all 
		<foreach collection="list" item="item">
		into playlist_content values (#{item.l_no}, #{item.m_id}, #{item.s_no}, #{item.a_no})
		</foreach>
	select * from dual
</insert>

<!-- 플레이 리스트 삭제 -->
<delete id="deletePlaylist" parameterType="list">
	delete from playlist
	where 
	<foreach collection="list" item="item" separator="or">
	(m_id = #{item.m_id} and l_no = #{item.l_no})
	</foreach>
</delete>

<!-- 내 플레이 리스트 상세조회 -->
<select id="selectSound"  resultMap="mySoundResultMap" parameterType="MyMusic">
	select sound.* from playlist_content playlist_content
	join sound sound on playlist_content.s_no = sound.s_no and playlist_content.a_no = sound.a_no
	where playlist_content.m_id = #{m_id} and playlist_content.l_no = #{l_no}
</select>

<!-- 플리 곡 - 가수 -->
<select id="mySoundSingerList" parameterType="map" resultType="Singer">
	select artist.artist_name, artist.artist_no
	from sound sound
	join singer singer on sound.s_no=singer.s_no and sound.a_no=singer.a_no
	join artist artist on singer.artist_no = artist.artist_no 
	join playlist_content playlist_content on playlist_content.s_no = sound.s_no and playlist_content.a_no = sound.a_no
	where playlist_content.m_id=#{m_id} and playlist_content.l_no=#{l_no}
</select>

<!-- 플리 곡 - 작사가 -->
<select id="mySoundWriterList" parameterType="map" resultType="Writer">
	select artist.artist_name
	from sound sound
	join sound_writer writer on sound.s_no = writer.s_no and sound.a_no = writer.a_no
	join artist artist on writer.artist_no = artist.artist_no 
	join playlist_content playlist_content on playlist_content.s_no = sound.s_no and playlist_content.a_no = sound.a_no
	where playlist_content.m_id=#{m_id} and playlist_content.l_no=#{l_no}
</select>

<!-- 플리 곡 - 작곡가 -->
<select id="mySoundComposerList" parameterType="map" resultType="Composer">
	select artist.artist_name
	from sound sound
	join sound_composer composer on sound.s_no = composer.s_no and sound.a_no = composer.a_no
	join artist artist on composer.artist_no = artist.artist_no 
	join playlist_content playlist_content on playlist_content.s_no = sound.s_no and playlist_content.a_no = sound.a_no
	where playlist_content.m_id=#{m_id} and playlist_content.l_no=#{l_no}
</select>

<!-- 플레이 리스트 만들기 -->
<insert id="insertPlaylist" parameterType="hashmap">
insert all
    into playlist values 
	    ( (select nvl(max(l_no),0)+1 from playlist where m_id=#{MyMusic.m_id} )
	    , #{MyMusic.m_id}, #{MyMusic.l_name}, #{MyMusic.l_private_yn}, #{MyMusic.l_image})
	    
	<foreach collection="soundList" item="item">
	into playlist_content values 
	( (select nvl(max(l_no),0)+1 from playlist where m_id=#{MyMusic.m_id} )
	, #{MyMusic.m_id}, #{item.s_no}, #{item.a_no})
	</foreach>
    
    select * from dual
</insert>

<!-- 플레이 리스트 만들기 - 곡 옮기기 -->
<select id="selectSoundList" parameterType="list" resultMap="soundResultMap">
	select sound.s_name, album.a_cover, sound.a_no, sound.s_no
	from sound sound 
	join album album on sound.a_no = album.a_no
	where (sound.a_no, sound.s_no) in
		<foreach collection="list" item="item" open="(" separator="," close=")">
			(#{item.a_no},#{item.s_no})
		</foreach>
</select>


<!-- 최근 들은 곡 --><!-- TODO 날짜 수정해야돼 -->
<select id="selectSoundRecent" resultMap="soundResultMap">
	select * from 
	(select DISTINCT sound.s_no, sound.a_no, sound.s_name, album.a_cover 
	from sound sound 
	join playinfo pinfo on sound.s_no = pinfo.s_no and sound.a_no = pinfo.a_no
	join album album on sound.a_no = album.a_no
	where pinfo.m_id = #{m_id} and pinfo.p_date BETWEEN sysdate-100 and sysdate)
	<![CDATA[
	where rownum <=20
	]]>
</select>

<!-- 최근 들은 곡 - 가수 -->
<select id="soundSingerList" parameterType="map" resultType="Singer">
	select artist.artist_name, artist.artist_no
	from sound sound
	join singer singer on sound.s_no=singer.s_no and sound.a_no=singer.a_no
	join artist artist on singer.artist_no = artist.artist_no 
	where sound.a_no=#{a_no} and sound.s_no=#{s_no}
</select>
</mapper>
