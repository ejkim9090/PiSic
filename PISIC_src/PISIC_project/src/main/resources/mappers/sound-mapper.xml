<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="Sound">

<resultMap type="Album" id="AlbumResultMap">
	<result column="a_no" property="a_no"/>
	<collection column="a_no" property="sounds" select="selectAlbumSound"></collection>
</resultMap>

<resultMap type="Sound" id="soundResultMap">
	<result column="s_no" property="s_no"/>
	<result column="a_no" property="a_no"/>
	<result column="s_name" property="s_name"/>
	<result column="s_lyrics1" property="s_lyrics1"/>
	<result column="s_lyrics2" property="s_lyrics2"/>
	<result column="s_age_yn" property="s_age_yn"/>
	<result column="s_path" property="s_path"/>
	<result column="g_no" property="g_no"/>
	<result column="a_cover" property="a_cover"/>
	<result column="a_name" property="a_name"/>
	<result column="g_name" property="g_name"/>
	<collection column="{a_no=a_no,s_no=s_no}" property="artist_names" select="soundSingerList"></collection>
	<collection column="{a_no=a_no,s_no=s_no}" property="sound_writers" select="soundWriterList"></collection>
	<collection column="{a_no=a_no,s_no=s_no}" property="sound_composers" select="soundComposerList"></collection>
</resultMap>

<!-- 앨범상세조회 - 앨범정보 -->
<select id="selectAlbum" resultMap="AlbumResultMap">
	select album.*, art.artist_name
	from album album join artist art on album.artist_no = art.artist_no 
	where album.a_no=#{a_no}
</select>

<!-- 앨범상세조회 - 수록곡 -->
<select id="selectAlbumSound" resultMap="soundResultMap">
	select sound.* 
	from sound sound join album album on sound.a_no=album.a_no 
	where album.a_no=#{a_no}
</select>

<!-- 곡 - 가수 -->
<select id="soundSingerList" parameterType="java.util.Map" resultType="string">
	select artist.artist_name
	from sound sound
	join singer singer on sound.s_no=singer.s_no and sound.a_no=singer.a_no
	join artist artist on singer.artist_no = artist.artist_no 
	where sound.a_no=#{a_no} and sound.s_no=#{s_no}
</select>

<!-- 곡 - 작사가 -->
<select id="soundWriterList" parameterType="java.util.Map" resultType="string">
	select artist.artist_name from sound_writer writer join artist artist using(artist_no)
	where writer.a_no=#{a_no} and writer.s_no=#{s_no} 
</select>

<!-- 곡 - 작곡가 -->
<select id="soundComposerList" parameterType="java.util.Map" resultType="string">
	select artist.artist_name from sound_composer composer join artist artist using(artist_no)
	where composer.a_no=#{a_no} and composer.s_no=#{s_no}
</select>

<!-- 곡 상세조회 - 곡정보 -->
<select id="selectSound" parameterType="Sound" resultMap="soundResultMap">
	select (select count(*) from sound_like where sound.a_no=1 and sound.s_no=1) cnt_like, sound.*, album.a_cover, album.a_name
	from sound sound 
	join album album on sound.a_no = album.a_no
	where sound.a_no=#{a_no} and sound.s_no=#{s_no} 
</select>

<!-- 선택 재생 -->
<select id="selectSoundList" parameterType="java.util.List" resultType="Sound">
	select s_name, s_path, artist.artist_name, album.a_cover  from sound sound 
	join album album on sound.a_no = album.a_no
	join singer singer on sound.s_no = singer.s_no and sound.a_no = singer.a_no
	join artist artist on singer.artist_no = artist.artist_no
	where (sound.a_no, sound.s_no) in
		<foreach collection="list" item="item" open="(" separator="," close=")">
			(#{item.a_no},#{item.s_no})
		</foreach>
	order by sound.s_no asc
</select>

<!-- 노래 좋아요 -->
<insert id="insertLike" parameterType="hashmap">
	insert into sound_like
	(m_id, s_no, a_no)
	values
	(#{memberVo.m_id}, #{soundVo.s_no}, #{soundVo.a_no})
</insert>
</mapper>
